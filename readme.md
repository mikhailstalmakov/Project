# depvis — Инструмент визуализации графа зависимостей (Вариант №20)

## 1. Общее описание

**depvis** — это инструмент для анализа и визуализации графа зависимостей пакетов Python. Программа парсит зависимости вручную без использования готовых менеджеров пакетов или специализированных библиотек для получения зависимостей. 

Основные возможности:
- Чтение конфигурации из XML-файла
- Извлечение зависимостей из PyPI или тестового репозитория
- Построение полного графа зависимостей с учетом транзитивности
- Фильтрация пакетов по подстроке
- Обработка циклических зависимостей
- Поиск обратных зависимостей
- Визуализация графа в формате SVG с использованием D2

Проект реализуется поэтапно:
1. **Этап 1**: Минимальный прототип с конфигурацией
2. **Этап 2**: Сбор данных о зависимостях
3. **Этап 3**: Основные операции (построение графа, DFS, фильтрация, циклы)
4. **Этап 4**: Дополнительные операции (обратные зависимости)
5. **Этап 5**: Визуализация (D2 → SVG)

## 2. Описание всех функций и настроек

### Параметры конфигурационного файла (XML)

Конфигурационный файл должен иметь следующую структуру:

```xml
<?xml version="1.0" encoding="utf-8"?>
<config>
    <package_name>ИМЯ_ПАКЕТА</package_name>
    <repo_url_or_path>URL_ИЛИ_ПУТЬ</repo_url_or_path>
    <test_repo_mode>true/false</test_repo_mode>
    <output_image_name>ПУТЬ_К_ФАЙЛУ.svg</output_image_name>
    <filter_substring>ПОДСТРОКА</filter_substring>
</config>
```

#### `package_name`
- **Описание**: Имя анализируемого пакета Python
- **Примеры**: `requests`, `numpy`, `A` (для тестового режима)
- **Ограничения**: Не должен содержать пробельных символов

#### `repo_url_or_path`
- **Описание**: URL-адрес репозитория PyPI/GitHub или путь к файлу тестового репозитория
- **Режим работы**: 
  - Если `test_repo_mode = false`: ожидается URL (например, `https://github.com/psf/requests`)
  - Если `test_repo_mode = true`: путь к файлу описания тестового репозитория (например, `test_repo.txt`)
- **Формат тестового файла**: Каждая строка вида `ПАКЕТ: ЗАВИСИМОСТЬ1 ЗАВИСИМОСТЬ2 ...`, где пакеты обозначаются большими латинскими буквами

#### `test_repo_mode`
- **Описание**: Режим работы с тестовым репозиторием
- **Значения**: `true` (использовать файл), `false` (использовать URL)
- **Альтернативные форматы**: `1`, `yes`, `y` для true; `0`, `no`, `n` для false

#### `output_image_name`
- **Описание**: Путь к выходному файлу изображения графа
- **Формат**: Рекомендуется расширение `.svg`
- **Примеры**: `output/deps.svg`, `output/requests_deps.svg`
- **Ограничения**: Директория должна существовать или быть создаваемой

#### `filter_substring`
- **Описание**: Подстрока для фильтрации пакетов при анализе
- **Применение**: Пакеты, имя которых содержит эту подстроку, исключаются из анализа
- **Пример**: `test` исключит все пакеты с "test" в названии
- **Особенности**: Может быть пустой строкой (фильтрация отключена)

### Основные функции программы

#### Этап 1: Чтение и валидация конфигурации
- `read_config(path)`: Читает XML-конфигурацию и извлекает параметры
- `validate_config(cfg, config_path)`: Валидирует все параметры с детальной обработкой ошибок
- `print_kv(params)`: Выводит все параметры в формате `ключ=значение`

#### Этап 2: Извлечение зависимостей
- Парсинг `setup.py` или `pyproject.toml` из репозитория
- Извлечение списка прямых зависимостей указанного пакета
- Поддержка тестового режима с чтением из файла

#### Этап 3: Построение графа
- `build_dependency_graph()`: Построение полного графа зависимостей алгоритмом DFS (Depth-First Search) с рекурсией
- Обработка транзитивных зависимостей
- Фильтрация пакетов по подстроке
- Обнаружение и обработка циклических зависимостей (предотвращение бесконечной рекурсии)

#### Этап 4: Обратные зависимости
- `find_reverse_dependencies()`: Поиск всех пакетов, которые зависят от заданного пакета
- Использование алгоритма обхода графа

#### Этап 5: Визуализация
- `generate_d2_code()`: Генерация текстового представления графа на языке D2
- Сохранение SVG-файла с использованием D2 CLI

## 3. Описание команд для сборки проекта и запуска тестов

### Требования

1. **Python 3.7+**
   ```bash
   python --version
   ```

2. **D2 CLI** (для визуализации на этапе 5)
   - Установка: https://d2lang.com/tour/install
   - Windows: `winget install --id D2lang.D2` или скачать с GitHub
   - Проверка: `d2 --version`

3. **Библиотеки Python** (если используются):
   ```bash
   pip install requests toml  # только если используются стандартные библиотеки для парсинга
   ```

### Запуск программы

#### Основной формат команды:
```bash
python depvis_stage1.py -c <конфиг.xml> [--stage <номер_этапа>]
```

#### Параметры командной строки:
- `-c, --config`: Обязательный параметр — путь к XML-конфигурационному файлу
- `--stage`: Номер этапа (1-5). Если не указан, выполняется текущий функционал

### Примеры запуска для каждого этапа

#### Этап 1: Минимальный прототип
```bash
python depvis_stage1.py -c test_config.xml
# или явно
python depvis_stage1.py -c test_config.xml --stage 1
```
**Ожидаемый результат**: Вывод всех параметров конфигурации в формате `ключ=значение`

#### Этап 2: Сбор данных
```bash
python depvis_stage1.py -c dependency_visualizer/config.xml --stage 2
```
**Ожидаемый результат**: Вывод списка прямых зависимостей указанного пакета

#### Этап 3: Основные операции
```bash
python depvis_stage1.py -c test_config.xml --stage 3
```
**Ожидаемый результат**: Построение полного графа зависимостей с учетом транзитивности

#### Этап 4: Дополнительные операции
```bash
python depvis_stage1.py -c test_config.xml --stage 4
```
**Ожидаемый результат**: Вывод обратных зависимостей для заданного пакета

#### Этап 5: Визуализация
```bash
python depvis_stage1.py -c test_config.xml --stage 5
```
**Ожидаемый результат**: Генерация SVG-файла с визуализацией графа зависимостей

### Тестирование обработки ошибок

#### Неверный путь к конфигу:
```bash
python depvis_stage1.py -c nonexistent.xml
# Ожидается: ERROR: Файл конфигурации не найден
```

#### Некорректный XML:
```bash
python depvis_stage1.py -c broken_config.xml
# Ожидается: ERROR: Ошибка парсинга XML
```

#### Отсутствующий параметр:
```bash
# Создайте config с отсутствующим <package_name>
python depvis_stage1.py -c incomplete_config.xml
# Ожидается: ERROR: Параметр 'package_name' отсутствует или пуст
```

## 4. Примеры использования

### Пример 1: Анализ пакета requests (этап 1-2)

**Создайте конфиг `config_requests.xml`:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<config>
    <package_name>requests</package_name>
    <repo_url_or_path>https://github.com/psf/requests</repo_url_or_path>
    <test_repo_mode>false</test_repo_mode>
    <output_image_name>output/requests_deps.svg</output_image_name>
    <filter_substring>test</filter_substring>
</config>
```

**Запуск:**
```bash
# Этап 1: Проверка конфигурации
python depvis_stage1.py -c config_requests.xml

# Этап 2: Получение прямых зависимостей
python depvis_stage1.py -c config_requests.xml --stage 2
```

### Пример 2: Тестовый репозиторий (этапы 3-5)

**Файл `test_repo.txt`:**
```
A: B C
B: D E
C: D F
D: G
E:
F: G
G:
```

**Конфиг `test_config.xml`:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<config>
    <package_name>A</package_name>
    <repo_url_or_path>test_repo.txt</repo_url_or_path>
    <test_repo_mode>true</test_repo_mode>
    <output_image_name>output/test_graph.svg</output_image_name>
    <filter_substring></filter_substring>
</config>
```

**Запуск:**
```bash
# Этап 3: Построение графа
python depvis_stage1.py -c test_config.xml --stage 3

# Этап 4: Обратные зависимости для пакета D
python depvis_stage1.py -c test_config.xml --stage 4

# Этап 5: Визуализация
python depvis_stage1.py -c test_config.xml --stage 5
# Результат: output/test_graph.svg
```

### Пример 3: С фильтрацией пакетов

**Конфиг с фильтром:**
```xml
<?xml version="1.0" encoding="utf-8"?>
<config>
    <package_name>A</package_name>
    <repo_url_or_path>test_repo.txt</repo_url_or_path>
    <test_repo_mode>true</test_repo_mode>
    <output_image_name>output/filtered_graph.svg</output_image_name>
    <filter_substring>G</filter_substring>
</config>
```

**Запуск:**
```bash
python depvis_stage1.py -c test_config_filtered.xml --stage 3
# Результат: Граф без пакетов, содержащих "G" в имени
```

### Пример 4: Обработка циклических зависимостей

**Файл `cycle_test.txt`:**
```
A: B
B: C
C: A
```

**Запуск:**
```bash
python depvis_stage1.py -c cycle_config.xml --stage 3
# Результат: Обнаружение цикла и корректная обработка (без бесконечной рекурсии)
```

## Структура проекта

```
.
├── dependency_visualizer/
│   ├── depvis_stage1.py      # Основной скрипт
│   ├── config.xml            # Пример конфигурации для реального пакета
│   └── README.md             # Внутренняя документация
├── test_config.xml           # Конфигурация для тестового режима
├── test_repo.txt             # Описание тестового репозитория
├── output/                   # Директория для выходных файлов
│   └── *.svg                 # Сгенерированные изображения
└── readme.md                 # Основная документация (этот файл)
```

## Примечания

- Программа не использует готовые менеджеры пакетов (pip, pipdeptree) для получения зависимостей
- Парсинг зависимостей осуществляется вручную из исходных файлов проекта
- Для визуализации требуется установленный D2 CLI
- Все этапы сохраняются в git-репозитории с детальными сообщениями коммитов
